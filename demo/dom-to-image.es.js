function t(t,e,o,n){return new(o||(o=Promise))((function(r,s){function i(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,a)}l((n=n.apply(t,e||[])).next())}))}var e;!function(t){t.WOFF="application/font-woff",t.TTF="application/font-truetype",t.EOT="image/eotapplication/vnd.ms-fontobject",t.GIF="image/gif",t.TIFF="image/tiff",t.SVG="image/svg+xml",t.JPEG="image/jpeg",t.JPG="image/jpeg",t.PNG="image/png",t.WEBP="image/webp"}(e||(e={}));const o=/url\(['"]?([^'"]+?)['"]?\)/g,n=t=>t.replace(/#/g,"%23").replace(/\n/g,"%0A"),r=(t,e)=>{const o=window.getComputedStyle(t).getPropertyValue(e);return parseFloat(o.replace("px",""))},s=t=>{const e=r(t,"border-left-width"),o=r(t,"border-right-width");return t.scrollWidth+e+o},i=t=>{const e=r(t,"border-top-width"),o=r(t,"border-bottom-width");return t.scrollHeight+e+o},a=t=>-1!==t.search(/^(data:)/),l=t=>-1!==t.search(o),c=t=>(t=>{let{url:e}=t;const{httpTimeout:o=3e4,cacheBust:n=!1,useCredentials:r=!1,successHandle:s=(()=>{}),failHandle:i=(()=>{})}=t;return n&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime()),new Promise((function(t){const n=new XMLHttpRequest;function a(e){console.error(e),t("")}n.onreadystatechange=function(){if(4===n.readyState)return 200!==n.status?(i(),void a("cannot fetch resource: "+e+", status: "+n.status)):void s(n,t)},n.ontimeout=()=>a(`timeout of ${o}ms occured while fetching resource: ${e}`),n.responseType="blob",n.timeout=o,r&&(n.withCredentials=!0),n.open("GET",e,!0),n.send()}))})(Object.assign(Object.assign({},t),{successHandle:(t,e)=>{const o=new FileReader;o.onloadend=function(){let t=o.result;e(t)},o.onerror=t=>{console.error("img url reader fail",t)},o.readAsDataURL(t.response)}})),h=(e,n)=>{if(!l(e))return Promise.resolve(e);const r=(t=>{const e=[];let n;for(;null!==(n=o.exec(t));)e.push(n[1]);return e.filter((function(t){return!a(t)}))})(e);let s=Promise.resolve(e);return r.forEach((e=>{s=s.then((o=>t(void 0,void 0,void 0,(function*(){e=n?((t,e)=>{const o=document.implementation.createHTMLDocument(),n=o.createElement("base");o.head.appendChild(n);const r=o.createElement("a");return o.body.appendChild(r),n.href=e,r.href=t,r.href})(e,n):e;const t=yield c({url:e});return o.replace((t=>new RegExp("(url\\(['\"]?)("+t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")+")(['\"]?\\))","g"))(e),"$1"+t+"$3")}))))})),s},u=(t,e)=>{if(!(e instanceof Element))return e;return Promise.resolve().then((()=>((t,e)=>{if(t.cssText)e.cssText=t.cssText;else for(const o of t)t.getPropertyValue(o)&&e.setProperty(o,t.getPropertyValue(o),t.getPropertyPriority(o))})(window.getComputedStyle(t),e.style))).then((()=>[":before",":after"].forEach((o=>function(o){const n=window.getComputedStyle(t,o),r=n.getPropertyValue("content");if(""===r||"none"===r)return;const s=(()=>{let t=0;return`u0000${`0000${(Math.random()*Math.pow(36,4)<<0).toString(36)}`.slice(-4)}${t++}`})();e.className=e.className+" "+s;const i=document.createElement("style");i.appendChild(function(t,e,o){const n=`.${t}:${e}`,r=o.getPropertyValue("content");let s="";if(o.cssText)s=`${o.cssText} content: ${r};`;else for(const t of o)s+=`${t}:${o.getPropertyValue(t)}${o.getPropertyPriority(t)?" !important":""};`;return document.createTextNode(`${n}{${s}}`)}(s,o,n)),e.appendChild(i)}(o))))).then((()=>f(e,t))).then((()=>m(e))).then((()=>e))};const d=t=>"data:,"===t?Promise.resolve(null):new Promise(((e,o)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{e(n)},n.onerror=o,n.src=t})),p=e=>t(void 0,void 0,void 0,(function*(){if(e instanceof HTMLImageElement)return yield function(e){return t(this,void 0,void 0,(function*(){if(!a(e.src)){const t=yield c({url:e.src});return new Promise((function(o,n){e.onload=o,e.onerror=n,e.src=t}))}}))}(e);yield(e=>t(void 0,void 0,void 0,(function*(){if(e.style){const t=e.style.getPropertyValue("background");if(!t)return e;const o=yield h(t);o&&e.style.setProperty("background",o,e.style.getPropertyPriority("background"))}})))(e);const o=Array.prototype.slice.call(e.childNodes).filter((t=>1===t.nodeType));return yield Promise.all(o.map((t=>p(t)))),e}));const g=(e,o,n=!1)=>t(void 0,void 0,void 0,(function*(){if(!n&&o&&!o(e))return;var t=e.childNodes;const r=e instanceof HTMLCanvasElement?yield d(e.toDataURL()):e.cloneNode(!1);if(u(e,r),0===t.length)return r;for(const e of t)g(e,o).then((t=>{t&&r.appendChild(t)}));return r})),f=(t,e)=>{e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)},m=t=>{t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((e=>{var o=t.getAttribute(e);o&&t.style.setProperty(e,o)})))},y=t=>{const e=function(t){let e=[];const o=[];for(const e of t)for(const t of e.cssRules)o.push.bind(t,e.cssRules);const n=t=>({resolve:()=>h(t.cssText,(t.parentStyleSheet||{}).href),src:()=>t.style.getPropertyValue("src")});try{for(const t of o)(t.type===CSSRule.FONT_FACE_RULE||l(t.style.getPropertyValue("src")))&&e.push(n(t))}catch(t){}return e}(document.styleSheets);return Promise.all(e.map((t=>t.resolve()))).then((t=>t.join("\n"))).then((e=>{const o=document.createElement("style");return t.appendChild(o),o.appendChild(document.createTextNode(e)),t}))};class w{constructor(t){const e={quality:1,cacheBust:!1,useCredentials:!1,httpTimeout:3e4,scale:window.devicePixelRatio};this.options=Object.assign(Object.assign({},e),t)}toSvg(){return Promise.resolve().then((()=>g(this.options.targetNode,this.options.filter,!0))).then(y).then(p).then(this.applyOptions.bind(this)).then((t=>(t.setAttribute("style",""),((t,e,o)=>Promise.resolve(t).then((t=>(t.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(t)))).then(n).then((t=>`<foreignObject x="0" y="0" width="100%" height="100%">${t}</foreignObject>`)).then((t=>`<svg xmlns="http://www.w3.org/2000/svg" width="${e}" height="${o}">${t}</svg>`)).then((t=>`data:image/svg+xml;charset=utf-8,${t}`)))(t,this.options.width||s(this.options.targetNode),this.options.height||i(this.options.targetNode)))))}toPng(){return this.drawCanvas().then((t=>t.toDataURL(e.PNG,this.options.quality)))}toJpg(){return this.drawCanvas().then((t=>t.toDataURL(e.JPG,this.options.quality)))}toCanvas(){return this.drawCanvas().then((t=>t))}toBlob(){return this.drawCanvas().then((t=>t.toBlob?new Promise((function(e){t.toBlob(e)})):(t=>new Promise((e=>{const o=window.atob(null==t?void 0:t.toDataURL().split(",")[1]),n=o.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=o.charCodeAt(t);e(new Blob([r],{type:"image/png"}))})))(t)))}toPixelData(){return this.drawCanvas().then((t=>{var e;return null===(e=t.getContext("2d"))||void 0===e?void 0:e.getImageData(0,0,s(this.options.targetNode),i(this.options.targetNode)).data}))}drawCanvas(){return this.toSvg().then(d).then((t=100,e=>new Promise(((o,n)=>{setTimeout((()=>{o(e)}),t)})))).then((t=>{const e=this.creatCanvas(),o=e.getContext("2d");return o&&o.drawImage(t,0,0,e.width,e.height),e}));var t}applyOptions(t){this.options.bgColor&&(t.style.backgroundColor=this.options.bgColor),this.options.width&&(t.style.width=this.options.width+"px"),this.options.height&&(t.style.height=this.options.height+"px");const e=this.options.style;for(const o in e)t.style[o]=e[o];return t}creatCanvas(){const t=document.createElement("canvas");if(t.width=(this.options.width||s(this.options.targetNode))*this.options.scale,t.height=(this.options.height||i(this.options.targetNode))*this.options.scale,this.options.bgColor){const e=t.getContext("2d");e&&(e.fillStyle=this.options.bgColor,e.fillRect(0,0,t.width,t.height))}return t}}export{w as default};
//# sourceMappingURL=dom-to-image.es.js.map
